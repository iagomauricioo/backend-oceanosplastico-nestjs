      - name: Deploy no Lightsail
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/github_actions_rsa bitnami@${{ secrets.LIGHTSAIL_IP }} << 'EOF'
          set -e
          export SHELL=/bin/bash
          echo "Diretório atual: $(pwd)"
          echo "Node.js versão: $(node -v)"
          echo "NPM versão: $(npm -v)"
          if ! command -v pm2 &> /dev/null; then
            echo "PM2 não está instalado. Instalando..."
            npm install -g pm2
          fi
          cd ~/nestjs || exit 1
          git pull origin master
          npm ci
          npm run build
          
          # Verifica se há processos PM2 rodando
          if pm2 list | grep -q online; then
            echo "Processos PM2 já estão rodando. Reiniciando..."
            pm2 restart all
          else
            echo "Nenhum processo PM2 rodando. Iniciando o processo..."
            pm2 start npm --name "nestjs-app" -- run start:prod
          fi
          EOF
